; -------- PlatformIO config for Electrosmith Daisy (Arduino + DaisyDuino) --------
[platformio]
default_envs = electrosmith_daisy

[env:electrosmith_daisy]
platform    = ststm32
board       = electrosmith_daisy
framework   = arduino

; --- Libraries used by your sketch ---
lib_deps =
  electro-smith/DaisyDuino@^1.6.0
  adafruit/Adafruit GFX Library@^1.12.2
  adafruit/Adafruit SSD1306@^2.5.15

; (Optional) avoid accidentally picking up a duplicate local lib name
lib_ignore = DaisyDuino 2

; --- Build flags ---
; - enable SDRAM/FMC HAL (DaisyDuino uses SDRAM)
; - enable USB CDC device so Serial works over USB
; - tune for FPU on Cortex-M7
build_flags =
  -DHAL_SDRAM_MODULE_ENABLED
  -DHAL_FMC_MODULE_ENABLED
  -DUSE_HAL_SDRAM
  -DUSBCON
  -DUSBD_USE_CDC
  -DHAL_PCD_MODULE_ENABLED
  -DARDUINO_DAISY_SEED
  -DARM_MATH_CM7
  -mfpu=fpv5-sp-d16
  -mfloat-abi=hard
  -O2
  -DUSB_PRODUCT="\"DaisyMFX\""
  -DUSB_MANUFACTURER="\"Daisy\""

; (STM32 core option for USB)
board_build.usb_mode = CDC

; If you need to pass extra defines to Adafruit SSD1306, add them here, e.g.:
;  -DSSD1306_NO_SPLASH

; The STM32 Arduino core defaults to -Os; we prefer -O2 above
build_unflags = -Os

; --- Upload via DFU bootloader ---
; Put Daisy in DFU: hold BOOT, tap RESET, release BOOT.
upload_protocol = dfu

; This keeps the task from “failing” on dfu-util’s harmless post-flash Error 74.
; Comment this out if you want strict exit codes.
upload_command = dfu-util -a 0 -s 0x08000000:leave -D $PROJECT_BUILD_DIR/$PIOENV/firmware.bin || true

; --- Serial monitor ---
monitor_speed = 115200

; Tip: open the right port (usbmodem) after app boots:
;   pio device list
;   pio device monitor -p /dev/tty.usbmodemXXXX -b 115200

